{% extends '../base.html' %}
{% load static %}

{% block content %}
<style>
    .custom-card {
        width: 300px;  /* Set your desired width */
        max-width: 100%;  /* Ensures it doesn't exceed the column width on small screens */
    }
    #hoverButton {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    #hoverButton:hover {
        background-color: #0056b3;
    }
    .form-group {
        padding: 4px;
    }
</style>
<div class="container-fluid">
    <div class="card">
        <div class="card-body">
            <div class="row" id="taskCategoryCards">
                {% for task_category in task_categories_file %}
                    <div class="col-md-2 col-sm-3" style="padding-bottom: 22px;">
                        <div class="card custom-card" style="padding: 6px; background-color: rgba(128, 128, 128, 0.137);">
                            <div class="d-flex align-items-center" style="padding: 3px;">
                                <svg style="padding-right: 4px;" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-list-task" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M2 2.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5V3a.5.5 0 0 0-.5-.5zM3 3H2v1h1z"/>
                                    <path d="M5 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5M5.5 7a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1zm0 4a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1z"/>
                                    <path fill-rule="evenodd" d="M1.5 7a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5H2a.5.5 0 0 1-.5-.5zM2 7h1v1H2zm0 3.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zm1 .5H2v1h1z"/>
                                </svg>
                                <a style="text-decoration: none;" href="{% url 'category_detail' task_category.pk %}">
                                    {% if task_category.name|length > 19 %}
                                        <span style="color: rgb(68, 68, 68);">{{ task_category.name|slice:":19" }}...</span>
                                    {% else %}
                                        <span style="color: rgb(68, 68, 68);">{{ task_category.name }}</span>
                                    {% endif %}
                                </a>
                                <div style="margin-left: auto;"  class="dropdown">
                                    <button class="btn btn-link btn-sm" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-three-dots-vertical" viewBox="0 0 16 16">
                                            <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/>
                                        </svg>
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                                        <li>
                                            <a class="dropdown-item edit-button" href="{% url 'update_task_category' task_category.pk %}">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pen" viewBox="0 0 16 16">
                                                    <path d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001m-.644.766a.5.5 0 0 0-.707 0L1.95 11.756l-.764 3.057 3.057-.764L14.44 3.854a.5.5 0 0 0 0-.708z"/>
                                                  </svg> Edit
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="#" style="text-decoration: none;">
                                                <form method="POST" action="{% url 'category_delete' task_category.pk %}">
                                                    {% csrf_token %}
                                                    <button type="submit" class="dropdown-item" style="background: none; border: none; color: blue; text-decoration: underline; cursor: pointer; padding: 0;">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash2" viewBox="0 0 16 16">
                                                            <path d="M14 3a.7.7 0 0 1-.037.225l-1.684 10.104A2 2 0 0 1 10.305 15H5.694a2 2 0 0 1-1.973-1.671L2.037 3.225A.7.7 0 0 1 2 3c0-1.105 2.686-2 6-2s6 .895 6 2M3.215 4.207l1.493 8.957a1 1 0 0 0 .986.836h4.612a1 1 0 0 0 .986-.836l1.493-8.957C11.69 4.689 9.954 5 8 5s-3.69-.311-4.785-.793"/>
                                                        </svg> Delete
                                                    </button>
                                                </form>
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card overflow-auto" style="text-align: center; display: flex; justify-content: center; align-items: center; flex-direction: column; height: 120px;">
                                <ul style="padding: 0;">
                                    {% for task in task_category.tasks.all %}
                                        <li>{{ task.title|slice:":7" }}</li>
                                    {% empty %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="21" height="21" fill="currentColor" class="bi bi-clipboard-x" viewBox="0 0 16 16">
                                            <path fill-rule="evenodd" d="M6.146 7.146a.5.5 0 0 1 .708 0L8 8.293l1.146-1.147a.5.5 0 1 1 .708.708L8.707 9l1.147 1.146a.5.5 0 0 1-.708.708L8 9.707l-1.146 1.147a.5.5 0 0 1-.708-.708L7.293 9 6.146 7.854a.5.5 0 0 1 0-.708"/>
                                            <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z"/>
                                            <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z"/>
                                        </svg>
                                    {% endfor %}
                                </ul>
                            </div>
                            <small>{{ task_category.created_at }}</small>
                        </div>
                    </div>
                {% empty %}
                    <center>
                        <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="currentColor" class="bi bi-list-columns" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M0 .5A.5.5 0 0 1 .5 0h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 0 .5m13 0a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5m-13 2A.5.5 0 0 1 .5 2h8a.5.5 0 0 1 0 1h-8a.5.5 0 0 1-.5-.5m13 0a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5m-13 2A.5.5 0 0 1 .5 4h10a.5.5 0 0 1 0 1H.5a.5.5 0 0 1-.5-.5m13 0a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5m-13 2A.5.5 0 0 1 .5 6h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m13 0a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5m-13 2A.5.5 0 0 1 .5 8h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m13 0a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5m-13 2a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m13 0a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5m-13 2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5m13 0a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5m-13 2a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H.5a.5.5 0 0 1-.5-.5m13 0a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5"/>
                          </svg>
                          <h2>No tasks added yet</h2>
                    </center>
                {% endfor %}
            </div>
        </div>
    </div>
    <a href="" id="hoverButton" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-lg" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2"/>
          </svg> <b>new</b>
    </a>
</div>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-folder" viewBox="0 0 16 16">
                        <path d="M.54 3.87.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3h3.982a2 2 0 0 1 1.992 2.181l-.637 7A2 2 0 0 1 13.174 14H2.826a2 2 0 0 1-1.991-1.819l-.637-7a2 2 0 0 1 .342-1.31zM2.19 4a1 1 0 0 0-.996 1.09l.637 7a1 1 0 0 0 .995.91h10.348a1 1 0 0 0 .995-.91l.637-7A1 1 0 0 0 13.81 4zm4.69-1.707A1 1 0 0 0 6.172 2H2.5a1 1 0 0 0-1 .981l.006.139q.323-.119.684-.12h5.396z"/>
                      </svg> Create Folder
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                
                <form id="addTaskCategory" action="">
                    {% csrf_token %}
                    <div class="form-group">
                        <input class="form-control" type="text" name="name" placeholder="Folder Name" required>
                    </div>
                    <button class="btn btn-primary form-control" type="submit">Create Folder</button>
                </form>

            </div>
        </div>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script>
    // Create Django Ajax Call for adding a Task Category
    $("form#addTaskCategory").submit(function (e) {
        e.preventDefault();
        var nameInput = $('input[name="name"]').val().trim();
        var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();  // Fetch the CSRF token from the form

        if (nameInput) {
            $.ajax({
                url: '{% url "create_task_category" %}',
                type: 'POST',
                data: {
                    'name': nameInput,
                    'csrfmiddlewaretoken': csrfToken
                },
                dataType: 'json',
                success: function (data) {
                    if (data.task_category) {
                        appendToTaskCategoryCards(data.task_category);
                        $('form#addTaskCategory').trigger("reset");
                    }
                },
                error: function (xhr, errmsg, err) {
                    alert("Could not create task category. Please try again.");
                }
            });
        } else {
            alert("Please enter a category name.");
        }


        function appendToTaskCategoryCards(taskCategory) {
            var nameDisplay = taskCategory.name.length > 19 ? taskCategory.name.slice(0, 19) + '...' : taskCategory.name;
            var newCardHtml = `
        <div class="col-md-2 col-sm-3" style="padding-bottom: 22px;">
            <div class="card custom-card" style="padding: 6px; background-color: rgba(128, 128, 128, 0.137);">
                <div class="d-flex align-items-center" style="padding: 3px;">
                    <svg style="padding-right: 4px;" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-list-task" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M2 2.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5V3a.5.5 0 0 0-.5-.5H2zm1 0H2v1h1V3z"/>
                        <path d="M5 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM5.5 7a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 4a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9z"/>
                        <path fill-rule="evenodd" d="M1.5 7a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5H2a.5.5 0 0 1-.5-.5zm1 .5H2v1H2z"/>
                    </svg>
                    <a style="text-decoration: none;" href="/category_detail/${taskCategory.id}/">
                        <span style="color: rgb(68, 68, 68);">${nameDisplay}</span>
                    </a>
                    <div style="margin-left: auto;" class="dropdown">
                        <button class="btn btn-link btn-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-three-dots-vertical" viewBox="0 0 16 16">
                                <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/>
                            </svg>
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                            <li><a class="dropdown-item" href="/category_edit/${taskCategory.id}">Edit</a></li>
                            <li>
                                <form method="POST" action="/category_delete/${taskCategory.id}">
                                    <input type="hidden" name="csrfmiddlewaretoken" value="${$('input[name="csrfmiddlewaretoken"]').val()}">
                                    <button type="submit" class="dropdown-item" style="background: none; border: none; color: blue; text-decoration: underline; cursor: pointer; padding: 0;">Delete</button>
                                </form>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="card overflow-auto" style="text-align: center; display: flex; justify-content: center; align-items: center; flex-direction: column; height: 120px;">
                    <ul style="padding: 0;">
                        <!-- Placeholder for tasks if any, to be handled dynamically if needed -->
                    </ul>
                </div>
                <small>${taskCategory.created_at}</small>
            </div>
        </div>`;

            $('#taskCategoryCards').prepend(newCardHtml);
        }
    });
</script>
    
{% endblock %}

