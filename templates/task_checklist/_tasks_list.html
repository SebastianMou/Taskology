<!-- _tasks_list.html -->
{% load static %}

{% for task in tasks %}
<tr id="task-row-{{ task.id }}">
    <!-- display when on laptop -->
    <td style="width: 25px; height: auto;" id="td-one">
        <button type="button" class="btn btn-link toggle-task-status" data-task-id="{{ task.id }}">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="{% if task.status != 'COMPLETED' %}bi bi-circle{% else %}bi bi-check2-circle{% endif %}" viewBox="0 0 16 16">
                <!-- Insert the appropriate path based on whether the task is completed or not -->
                {% if task.status != 'COMPLETED' %}
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                {% else %}
                    <path d="M2.5 8a5.5 5.5 0 1 1 8.25-4.764.5.5 0 0 0 .5-.866A6.5 6.5 0 1 0 14.5 8a .5.5 0 0 0-1 0 5.5 5.5 0 1 1-11 0"/>
                    <path d="M15.354 3.354a.5.5 0 0 0-.708-.708L8 9.293 5.354 6.646a.5.5 0 1 0-.708.708l3 3 a.5.5 0 0 0 .708 0z"/>
                {% endif %}
            </svg>
        </button>
    </td>
    <td>
        <div class="flex-container">
            <p id="title-{{ task.id }}" class="task-link {% if task.status == 'COMPLETED' %}text-strikethrough{% endif %}" data-bs-toggle="offcanvas" data-bs-target="#sidebarRight2" aria-controls="sidebarRight2" data-url="{% url 'items_detail' task.pk %}">
                {{ task.title }}
            </p>
        </div>
    </td>
    <td id="element">{{ task.created_at }}</td>
    <td id="element" class="task-status">
        <span class="badge {% if task.status != 'COMPLETED' %}bg-info text-dark{% else %}bg-success text-dark{% endif %}">
            {{ task.status }}
        </span>
    </td>
    <td id="element" class="text-end">
        <div class="dropdown">
            <button class="btn btn-link" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-three-dots" viewBox="0 0 16 16">
                    <path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/>
                </svg>
            </button>
            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                <li>
                    <a class="dropdown-item" href="{% url 'edit_task_ck' task.pk %}">Edit</a>
                </li>
                <li>
                    <a class="dropdown-item" href="{% url 'delete_task_ck' task.pk %}">Delete</a>
                </li>
            </ul>
        </div>
    </td>
</tr>
{% for subtask in task.subtasks.all %}
    <tr>
        <td style="width: 25px;">
            <td style="margin-bottom: 10px;">
                <div class="d-flex">
                    <button type="button" class="btn btn-link toggle-task-status" data-subtask-id="{{ subtask.id }}" onclick="toggleSubtaskStatus(this)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="{% if subtask.is_complete %}bi bi-check2-circle{% else %}bi bi-circle{% endif %}" viewBox="0 0 16 16">
                            {% if subtask.is_complete %}
                                <path d="M2.5 8a5.5 5.5 0 0 1 8.25-4.764.5.5 0 0 0 .5-.866A6.5 6.5 0 1 0 14.5 8a.5.5 0 0 0-1 0 5.5 5.5 0 1 1-11 0"/>
                                <path d="M15.354 3.354a.5.5 0 0 0-.708-.708L8 9.293 5.354 6.646a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0z"/>
                            {% else %}
                                <path d="M8 15A7 7 0 1 1 8 1 a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0 a8 8 0 0 0 0 16"/>
                            {% endif %}
                        </svg>
                    </button>
                    <p class="subtask-link" data-url="{% url 'subtask_detail' subtask.pk %}" data-bs-toggle="offcanvas" data-bs-target="#sidebarRight3" aria-controls="sidebarRight3" style="margin-left: 10px;">
                        {% if subtask.is_complete %}
                            <s>{{ subtask.title }}</s>
                        {% else %}
                            {{ subtask.title }}
                        {% endif %}
                    </p>
                </div>
            </td>
        </td>
    </tr>
{% endfor %}

{% empty %}
<tr>
    <td colspan="5" class="text-center">No tasks found</td>
</tr>
{% endfor %}

<!-- Sidebar Content View Task -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="sidebarRight2" aria-labelledby="sidebarLabel">
    <div class="offcanvas-header">
    <p id="sidebarLabel">Task</p>
    <a type="button" class="text-reset" data-bs-dismiss="offcanvas" aria-label="Close">
        <svg xmlns="http://www.w3.org/2000/svg" width="19" height="19" fill="currentColor" class="bi bi-caret-right" viewBox="0 0 16 16">
            <path d="M6 12.796V3.204L11.481 8zm.659.753 5.48-4.796a1 1 0 0 0 0-1.506L6.66 2.451C6.011 1.885 5 2.345 5 3.204v9.592a1 1 0 0 0 1.659.753"/>
        </svg>
    </a>
    </div>
    <div class="offcanvas-body">
        <div class="container-fluid full-height">
            <div class="task-detail">
                <!-- task detail will display here (dynamicly loaded) -->
            </div>
        </div>
    </div>
</div>

<script>
     $(document).ready(function(){
        $(".task-link").click(function(event){
            event.preventDefault();  // prevent the default action
            var detailUrl = $(this).data('url'); // Get the URL from the data attribute
            $.ajax({
                url: detailUrl,
                success: function(result){
                    $(".task-detail").html(result);
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("Error:", textStatus, errorThrown); // Print the error to the console
                }
            });
        });
    });

    $(document).ready(function() {
        $('.toggle-task-status').on('click', function() {
            var btn = $(this);
            var taskId = btn.data('task-id');
            var row = $('#task-row-' + taskId);
            var titleElement = $('#title-' + taskId); // Ensure this ID is set correctly

            $.ajax({
                url: `/complete-task/${taskId}/`,
                type: 'POST',
                data: {
                    csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val(),
                    task_id: taskId,
                },
                success: function(response) {
                    // Update the icon based on the new status
                    var newIconHtml = (response.status === 'COMPLETED') ?
                        '<svg class="bi bi-check2-circle" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M2.5 8a5.5 5.5 0 1 1 8.25-4.764.5.5 0 0 0 .5-.866A6.5 6.5 0 1 0 14.5 8a.5.5 0 0 0-1 0 5.5 5.5 0 1 1-11 0"/><path d="M15.354 3.354a.5.5 0 0 0-.708-.708L8 9.293 5.354 6.646a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0z"/></svg>' :
                        '<svg class="bi bi-circle" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/></svg>';
                    btn.html(newIconHtml);

                    // Toggle strikethrough class based on status
                    if (response.status === 'COMPLETED') {
                        titleElement.addClass('text-strikethrough');
                    } else {
                        titleElement.removeClass('text-strikethrough');
                    }

                    // Update the status badge
                    var newStatusBadgeHtml = (response.status === 'COMPLETED') ?
                        '<span class="badge bg-success text-dark">COMPLETED</span>' :
                        '<span class="badge bg-info text-dark">NOT_STARTED</span>';
                    row.find('.task-status').html(newStatusBadgeHtml);
                }
            });
        });
    });

    function toggleSubtaskStatus(button) {
        const subtaskId = button.getAttribute('data-subtask-id');
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch(`{% url 'toggle_subtask_status' %}?subtask_id=${subtaskId}`, {
            method: 'POST',
            headers: {'X-CSRFToken': csrftoken},
            credentials: 'same-origin'
        }).then(response => response.json())
        .then(data => {
            const titleElement = button.closest('.d-flex').querySelector('p.subtask-link');
            const svgElement = button.querySelector('svg');
            if (data.is_complete) {
                svgElement.innerHTML = `<path d="M2.5 8a5.5 5.5 0 0 1 8.25-4.764.5.5 0 0 0 .5-.866A6.5 6.5 0 1 0 14.5 8a.5.5 0 0 0-1 0 5.5 5.5 0 1 1-11 0"/><path d="M15.354 3.354a.5.5 0 0 0-.708-.708L8 9.293 5.354 6.646a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0z"/>`;
                titleElement.innerHTML = `<s>${data.title}</s>`;
            } else {
                svgElement.innerHTML = `<path d="M8 15A7 7 0 1 1 8 1 a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0 a8 8 0 0 0 0 16"/>`;
                titleElement.textContent = data.title; // Use textContent for non-HTML updates
            }
        }).catch(error => console.error('Error:', error));
    }

    $(document).ready(function(){
        $(".subtask-link").click(function(event){
            event.preventDefault();  // prevent the default action
            var detailUrl = $(this).data('url'); // Get the URL from the data attribute
            $.ajax({
                url: detailUrl,
                success: function(result){
                    $(".sudtask-detail").html(result);
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("Error:", textStatus, errorThrown); // Print the error to the console
                }
            });
        });
    });
</script>

